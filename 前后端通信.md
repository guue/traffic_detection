# API文档

## 概述

本文档提供了后端（基于Python Flask框架）与前端（使用易语言）的集成指南，旨在实现视频追踪功能的启动、获取实时数据（包括视频帧、车辆信息、类别统计和车流量计数）等操作。

## 后端实现（Python Flask）

首先，确保您的后端服务能够处理前端的请求，并返回相应的数据。以下步骤基于您提供的代码，将展示如何创建Flask应用，以及如何通过API提供实时数据。

### 1. Flask应用初始化

创建一个名为 `app.py` 的文件，用于初始化Flask应用并定义API接口。

```python
from flask import Flask, request, jsonify
import threading

app = Flask(__name__)

# 导入之前定义的 VideoTracker 类
from detect_v9 import VideoTracker, parse_opt

# 初始化 VideoTracker
opt = parse_opt()
video_tracker = VideoTracker(opt)

def start_video_tracking():
    video_tracker.run()

@app.route('/start-video-detection', methods=['POST'])
def start_video_detection():
    data = request.json
    video_source = data.get('video_source', opt.source)  # 使用默认视频源，如果没有提供
    opt.source = video_source  # 更新视频源
    # 启动一个新线程来运行视频检测，以避免阻塞主线程
    threading.Thread(target=start_video_tracking).start()
    return jsonify({"message": "Video detection started", "video_source": video_source})

@app.route('/api/car-status', methods=['GET'])
def get_car_status():
    # 假设video_tracker中有一个方法可以返回最新的车辆状态列表
    car_status = video_tracker.get_car_status()
    return jsonify(car_status)

@app.route('/api/class-counts', methods=['GET'])
def get_class_counts():
    # 假设video_tracker中有一个方法可以返回最新的类别统计
    class_counts = video_tracker.get_class_counts()
    return jsonify(class_counts)

@app.route('/api/vehicle-count', methods=['GET'])
def get_vehicle_count():
    # 假设video_tracker中有一个方法可以返回当前的车流量计数
    vehicle_count = video_tracker.get_vehicle_count()
    return jsonify({"count": vehicle_count})

if __name__ == '__main__':
    app.run(debug=True)
```

### 2. 定义API接口 

- **启动视频检测**: `/start-video-detection` POST接口，用于启动视频流的检测。
- **视频源设置**：`/configure-video-source` 接口 设置视频源
- **获取实时数据**: 根据您的需求，可以创建额外的API接口来提供实时车辆信息、类别统计和车流量计数等。

### 3. 运行Flask应用

```bash
python app.py
```

## 前端实现（易语言）

在易语言中，您可以使用HTTP客户端组件来发送请求到后端Flask应用，并处理返回的数据。

### 1. 启动视频检测

使用易语言发送POST请求到 `/configure-video-source`  发送视频源更换    `/start-video-detection` 接口，以启动视频检测。

```c
定义 http 为 新建 HTTP客户端
定义 url 为 "http://127.0.0.1:5000/configure-video-source"
定义 postData 为 "{""video_source"": ""http://example.com/video.mp4""}"  ' JSON格式的字符串
定义 response 为 http.发送POST请求(url, postData)

如果 response.状态码 = 200 则
    输出 "视频源配置成功"
否则
    输出 "配置视频源失败，状态码：" + 转为文本(response.状态码)

定义 url 为 "http://ip:port/start-video-detection"
定义 postData 为 "{""video_source"": ""http://example.com/video.mp4""}"  ' JSON格式的字符串
定义 response 为 http.发送POST请求(url, postData)
如果 response.状态码 = 200 则
    输出 "视频检测启动成功"
否则
    输出 "启动失败，状态码：" + 转为文本(response.状态码)
```

### 2. 获取实时数据

假设已定义相应的接口，例如 `/api/car-status`，易语言可以周期性地发送GET请求来获取数据。

```c
定义 http 为 新建 HTTP客户端
定义 baseURL 为 "http://127.0.0.1:5000/api"

' 获取实时车辆信息
定义 carStatusURL 为 baseURL + "/car-status"
定义 response 为 http.发送GET请求(carStatusURL)
如果 response.状态码 = 200 则
    输出 "获取到车辆状态信息：" + response.响应正文
否则
    输出 "获取车辆状态信息失败，状态码：" + 转为文本(response.状态码)

' 获取类别统计
定义 classCountsURL 为 baseURL + "/class-counts"
定义 response 为 http.发送GET请求(classCountsURL)
如果 response.状态码 = 200 则
    输出 "获取到类别统计：" + response.响应正文
否则
    输出 "获取类别统计失败，状态码：" + 转为文本(response.状态码)

' 获取车流量计数
定义 vehicleCountURL 为 baseURL + "/vehicle-count"
定义 response 为 http.发送GET请求(vehicleCountURL)
如果 response.状态码 = 200 则
    输出 "获取到车流量计数：" + response.响应正文
否则
    输出 "获取车流量计数失败，状态码：" + 转为文本(response.状态码)

```

## 注意事项

- 确保后端服务在启动前已正确配置并测试无误。
- 调整前端和后端的IP地址和端口号，以确保它们能够正确通信。
- 获取实时信息应与检测处于不同进程或线程 以达到并行运行的效果
- 所有示例均需要调整 后端框架仅仅是参考 提供思路



